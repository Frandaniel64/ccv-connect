# Dockerfile para Laravel Backend
FROM php:8.1-fpm

# Instalar dependencias del sistema
RUN apt-get update && apt-get install -y \
    git \
    curl \
    libpng-dev \
    libonig-dev \
    libxml2-dev \
    zip \
    unzip \
    libzip-dev \
    && docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd zip \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Instalar Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Establecer directorio de trabajo
WORKDIR /var/www/backend

# Copiar el cÃ³digo del backend
COPY backend/ .

# Instalar dependencias de PHP (sin --no-dev para desarrollo)
RUN composer install --optimize-autoloader --no-interaction

# Crear directorios necesarios si no existen
RUN mkdir -p storage/framework/cache/data \
    storage/framework/sessions \
    storage/framework/views \
    storage/logs \
    bootstrap/cache

# Establecer permisos correctos
RUN chown -R www-data:www-data /var/www/backend \
    && chmod -R 775 /var/www/backend/storage \
    && chmod -R 775 /var/www/backend/bootstrap/cache

# Crear script de inicio
RUN echo '#!/bin/bash\n\
    set -e\n\
    \n\
    echo "ðŸš€ Iniciando configuraciÃ³n de Laravel..."\n\
    \n\
    # Esperar a que MySQL estÃ© disponible\n\
    echo "â³ Esperando a MySQL..."\n\
    until php artisan migrate:status 2>/dev/null; do\n\
    echo "MySQL no estÃ¡ listo - esperando..."\n\
    sleep 2\n\
    done\n\
    \n\
    echo "âœ… MySQL estÃ¡ listo"\n\
    \n\
    # Verificar si existe .env, si no, copiar de .env.example\n\
    if [ ! -f .env ]; then\n\
    echo "ðŸ“ Creando archivo .env..."\n\
    cp .env.example .env\n\
    fi\n\
    \n\
    # Generar clave de aplicaciÃ³n si no existe\n\
    if ! grep -q "APP_KEY=base64:" .env; then\n\
    echo "ðŸ”‘ Generando clave de aplicaciÃ³n..."\n\
    php artisan key:generate --force\n\
    fi\n\
    \n\
    # Limpiar cachÃ©\n\
    echo "ðŸ§¹ Limpiando cachÃ©..."\n\
    php artisan config:clear\n\
    php artisan cache:clear\n\
    php artisan route:clear\n\
    php artisan view:clear\n\
    \n\
    # Ejecutar migraciones\n\
    echo "ðŸ—„ï¸  Ejecutando migraciones..."\n\
    php artisan migrate --force\n\
    \n\
    # Optimizar para producciÃ³n\n\
    echo "âš¡ Optimizando aplicaciÃ³n..."\n\
    php artisan config:cache\n\
    php artisan route:cache\n\
    \n\
    echo "âœ¨ Laravel estÃ¡ listo!"\n\
    \n\
    # Iniciar PHP-FPM\n\
    exec php-fpm\n\
    ' > /usr/local/bin/start.sh && chmod +x /usr/local/bin/start.sh

# Exponer puerto
EXPOSE 9000

# Usar el script de inicio
CMD ["/usr/local/bin/start.sh"]
